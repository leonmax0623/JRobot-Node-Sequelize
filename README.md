# jrobot-backend

Данный сервис является основным бэкендом приложения JRobot. Здесь происходит всё взаимодействие с базой данных, здесь находится роутер, с которым взаимодействует фронт, и здесь же расположен сервер `socket.io`, через который работает тренажёр и серверное распознавание речи.

Работает на `Node.JS`, используется фреймворк `koa.js` для развёртки сервера и `socket.io` для тренажёра/распознавания.

Сервис работает в связке с несколькими другими:
- `jrobot-backend-comparator` - сервис на Python, который занимается семантическим анализом текста на сходство. Принимает эталонный текст, принимает попытку под этот текст и возвращает boolean, схожи они или нет. Является сервером socket.io тоже. Подробнее см. доки этого сервиса.
- `jrobot-backend-audio` - сервис, который является обычным сервером на koa, и который принимает специальные запросы для работы с аудио. Умеет конвертировать и соединять в одно. Используется в тренажёре (для конвертации в mp3 для iOS/Safari) и при прослушивании записей для соединения кусочков. Подробнее см. соответствующие доки.
- `jrobot-backend-yandex-iam-token` - сервер `socket.io`, который периодически (раз в 10 часов) берёт у яндекса новый IAM-Token и информирует об этом всех своих слушателей. Токен нужен для синтеза речи в Яндекс Speechkit. Подробнее см. соответствующие доки.
- https://github.com/alphacep/vosk-server - websocket сервер для распознавания речи. Подробнее см. пункт ниже.

## Как все работает

Код содержит в себе комментарии. Начинать изучение можно с `src/main.js`.

## База данных

Используется PostgreSQL. В сервисе всё взаимодействие осуществляется через **Sequelize ORM**. Доки: https://sequelize.org/master/

Конфиг бинарника sequelize (`npx sequelize...`) в файле `.sequelizerc`. Конфиг баз данных в `config/sequelize.config.json`. Все модели лежат в папке `data/models`.

## Запуск

Перед запуском обязательно:
```
yarn install
```

Запуск:
```
node .
```

Для работы в production нужно указать множество дополнительных флагов через переменные окружения.
Подробнее смотри соответствующий раздел.

Всё начинается в `scr/main.js`, что указано и в `package.json`.

---

## Структура файлов проекта

#### config

Здесь лежит основной конфиг приложения, конфиг Sequelize и ключ авторизации в Google для синтеза (это использовалось в англ. версии).

#### data

- `migrations` - миграции БД при каких-либо преобразованиях моделей.
- `models` - сами модели Sequelize и `index.js`, из которого импортируется `db`.

#### src

Основной рабочий код приложения.

- main.js - Здесь происходит запуск всего вообще
- app.js - Здесь именно инициализация самого сервера. Эта логика была отделена из `main.js` для удобства тестирования.
- routers - папка с публичным, приватным и административным роутером (root).
- middleware - папка с одним единственным файлом - логгером.
- locales - локализованные реплики для тренажёра
- tools - папка с различными модулями, концентрирующими в себе ту или иную группу фунций.
- sockets - сервер `socket.io`, тренажёр и распознавание.
- scripts - небольшие утилиты, используемые при разработке.
- amoCRM - модули, отвечающие за интеграцию с amoCRM.

#### static

Шаблоны писем, которые отправляются пользователям и подгружаюся в модуле `src/tools/mailer`.

#### test

Тесты.

---

## Переменные окружения

Иначе говоря, то, что находится в `process.env.*`.

- `PORT` - основной порт, на котором разворачивается сервер. По умолчанию - `3000`.
- `IAM_PORT` - порт подключения к `jrobot-backend-yandex-iam-token`. По умолчанию - `3025`.
- `COMPARE_PORT` - порт подключения к `jrobot-backend-comparator`. По умолчанию - `10218`.
- `AUDIO_WORKER_PORT` - порт подключения к `jrobot-backend-audio`. По умолчанию - `10210`.
- `STT_PORT` - порт подключения к контейнеру распознавания речи. По умолчанию - `2700`.
- `NODE_ENV` - `development`, `test` или `production`. Много где расположено, в том числе влияет на выбор базы данных. Думаю, значение этой переменной можно не объяснять.
- `FORCE_COLOR` - для `chalk`'а. Если выставить в 0, то убирает цветастость в логах, что полезно в `production`. 
- `KNOCK` - если есть любое значение, будет работать `knocker`. Подробнее о том, что сие такое есть, в соответствующем разделе.
- `HOST` - где хостится сервер. Используется для генерации ссылки для входа при отправки письма на почту. По умолчанию - `https://app.jrobot.pro`.
- `NO_MAILS` - если хоть какое-то truthy значение, то письма из модуля `mailer` отправляться не будут.
- `LOCALE` - ru или en. Используется в диалоге на fault-реплики.
- `TTS` - если `google`, то будет использоваться синтез Google.
- `IGNORE_AMO_HOOKS` - игнорировать ли все хуки, кроме `accountCreated`.
- `SETUP_METRICS` - включить ли метрики (периодический сбор статистики и отправка в amoCRM)

## Интеграция с Sentry

В production для отлавливания ошибок и отладочной информации используется Sentry. Доки: https://docs.sentry.io/

## Интеграция с amoCRM

Подробнее об этом см. файлы в папке src/amoCRM. Коротко - в некоторых частях программы используются специальные хуки из этой папки, которые обновляют данные в БД и взаимодействуют с amoCRM через их API.

## Knocker

Это специальная и довольно странная в плане архитектура штука. Грубо говоря, я, текущий разработчик, захардкодил в некоторые места специальные *сигнализации*, которые отправляют текстовые сообщения на определённый адрес (с которого я получаю моментальные уведомления) в случае критических ошибок. Это сконцентрировано в модуле `src/tools/knocker`.

## Серверное распознавание речи

Для того, чтобы это работало, нужен дополнительно работающий docker-контейнер, который запускается следующим образом:

```
docker run -d -p 2700:2700 alphacep/kaldi-ru:latest
```

Можно указать и свои порты на любой вкус. Я пробовал, у меня не вышло, возникали ошибки.

**Эта программа заточена под работу строго с аудио в формате WAV c sampleRate = 8000.** Умеет обрабатывать поступательно, кусочками.

## Тесты

Написаны с помощью `mocha`, `chai` и `sinon`. Тестами покрыто далеко не всё. Не покрыты довольно важные части программы - сбор статистики и вообще всё, что лежит в папке `src/sockets`.

## Что нужно удалить при передаче новой команде

- Интеграция с amoCRM
- Sentry DSN
- Knocker
- Данные почты care@jrobot.pro
- Ключ google-auth
- Почистить пароли в sequelize.config.json
